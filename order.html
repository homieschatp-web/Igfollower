<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus | Secure Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f2fe; --dark: #020617; --error: #ff4d4d; }
        body { 
            background: var(--dark); color: #e2e8f0; font-family: 'Poppins', sans-serif; 
            background: radial-gradient(circle at 50% 100%, #001a33 0%, #020617 100%);
            min-height: 100vh;
        }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .input-glow:focus { border-color: var(--neon); box-shadow: 0 0 15px rgba(0, 242, 254, 0.2); }
        .error-glow { border: 1px solid var(--error); background: rgba(255, 77, 77, 0.05); }
        
        /* Character Counter Styling */
        #char-count { font-size: 10px; transition: color 0.3s; }
        .count-valid { color: #00f2fe; }
        .count-invalid { color: #64748b; }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <header class="w-full max-w-md mb-8 flex justify-between items-center px-2">
        <button onclick="history.back()" class="text-slate-400 orbitron text-[10px] flex items-center gap-2 hover:text-cyan-400 transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            RETURN_STORE
        </button>
        <span class="orbitron text-[9px] font-bold text-white/40 tracking-widest">SECURE_PAYMENT_v4</span>
    </header>

    <main class="w-full max-w-md">
        <div class="glass p-8 rounded-[3rem] relative border-t border-white/10 shadow-2xl">
            
            <div id="loading-overlay" class="absolute inset-0 bg-[#020617] z-30 flex flex-col items-center justify-center rounded-[3rem]">
                <div class="w-10 h-10 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mb-4"></div>
                <p class="orbitron text-[9px] text-cyan-400 tracking-widest">VALIDATING_PACKAGE...</p>
            </div>

            <div class="error-glow p-4 rounded-2xl mb-8 border border-red-500/30 flex items-start gap-3">
                <span class="text-red-500 mt-1">⚠️</span>
                <p class="text-[10px] text-red-400 font-bold orbitron leading-relaxed">
                    CRITICAL: ENTER THE CORRECT 16-DIGIT REDEEM CODE. DO NOT SUBMIT USED OR EXPIRED CODES. ATTEMPTING TO REUSE CODES WILL VOID YOUR ACCOUNT.
                </p>
            </div>

            <div class="text-center mb-8">
                <p class="orbitron text-[9px] text-cyan-400 tracking-tighter uppercase mb-1" id="display-tier">---</p>
                <h1 class="text-6xl font-bold tracking-tighter text-white" id="display-qty">0</h1>
                <p class="text-slate-500 text-[10px] orbitron tracking-[0.2em] mt-2">INSTAGRAM_FOLLOWERS</p>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="orbitron text-[9px] text-slate-500 mb-2 ml-1 block">TARGET_ACCOUNT_URL</label>
                    <input type="url" id="target-link" placeholder="https://instagram.com/..." 
                           class="w-full bg-black/40 border border-white/10 p-4 rounded-2xl text-xs outline-none input-glow transition-all">
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <label class="orbitron text-[9px] text-slate-500 block">16-DIGIT_REDEEM_CODE</label>
                        <span id="char-count" class="orbitron font-bold">0/16</span>
                    </div>
                    <input type="text" id="redeem-code" maxlength="16" placeholder="XXXX XXXX XXXX XXXX" 
                           oninput="updateCount(this)"
                           class="w-full bg-black/60 border border-cyan-500/20 p-4 rounded-2xl text-sm outline-none input-glow transition-all uppercase font-mono tracking-[0.3em] text-cyan-400 placeholder:text-slate-800">
                    
                    <div class="mt-4 p-3 bg-white/5 rounded-xl border border-white/5">
                        <p class="orbitron text-[8px] text-cyan-400 text-center font-bold">FIXED PAYMENT METHOD: REDEEM_ONLY</p>
                    </div>
                </div>

                <div class="pt-6 border-t border-white/5 flex justify-between items-center">
                    <span class="orbitron text-[10px] text-slate-500">SETTLEMENT_TOTAL</span>
                    <span class="text-3xl font-bold text-white tracking-tighter" id="display-price">₹0</span>
                </div>

                <button onclick="placeOrder()" id="btn-submit" class="w-full py-5 bg-cyan-500 text-black font-bold orbitron text-[11px] rounded-2xl shadow-xl shadow-cyan-500/20 active:scale-95 transition-all hover:brightness-110">
                    AUTHORIZE_DEPLOYMENT
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCoVj4nvQJULBMD_KYpGfRWi4npme6RNnM", 
            authDomain: "mms-f37cf.firebaseapp.com", 
            projectId: "mms-f37cf", 
            storageBucket: "mms-f37cf.firebasestorage.app", 
            messagingSenderId: "85615411698", 
            appId: "1:85615411698:web:ab25f02dac6efa1e6eeb6b" 
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, serviceData = null;

        // Character Counter Logic
        window.updateCount = (el) => {
            const count = el.value.length;
            const counter = document.getElementById('char-count');
            counter.innerText = `${count}/16`;
            if(count === 16) {
                counter.className = "orbitron font-bold text-cyan-400";
            } else {
                counter.className = "orbitron font-bold text-slate-500";
            }
        };

        onAuthStateChanged(auth, u => { if(!u) window.location.href = "index.html"; currentUser = u; });

        const urlParams = new URLSearchParams(window.location.search);
        const serviceId = urlParams.get('id');

        if(serviceId) {
            const fetchDetails = async () => {
                const docSnap = await getDoc(doc(db, "services", serviceId));
                if (docSnap.exists()) {
                    serviceData = docSnap.data();
                    document.getElementById('display-tier').innerText = serviceData.name;
                    document.getElementById('display-qty').innerText = serviceData.quantity.toLocaleString();
                    document.getElementById('display-price').innerText = `₹${serviceData.price}`;
                    document.getElementById('loading-overlay').style.display = 'none';
                } else { window.location.href = "home.html"; }
            };
            fetchDetails();
        }

        window.placeOrder = async () => {
            const link = document.getElementById('target-link').value;
            const redeem = document.getElementById('redeem-code').value;
            const btn = document.getElementById('btn-submit');

            if(!link || !redeem) return alert("Please fill all fields.");
            if(redeem.length !== 16) return alert("Error: Redeem code must be exactly 16 characters.");

            if(!confirm("HAVE YOU ENTERED THE CORRECT REDEEM CODE? USED CODES WILL BE REJECTED.")) return;

            btn.disabled = true;
            btn.innerText = "AUTHENTICATING...";

            try {
                const orderId = "NX-" + Math.random().toString(36).substr(2, 6).toUpperCase();
                await addDoc(collection(db, "orders"), {
                    orderId,
                    userEmail: currentUser.email,
                    profileLink: link,
                    redeemCode: redeem.trim().toUpperCase(),
                    tierName: serviceData.name,
                    price: serviceData.price,
                    status: "Pending",
                    createdAt: serverTimestamp()
                });

                alert("SUCCESS: Your 16-digit code has been logged. Order ID: " + orderId);
                window.location.href = "home.html";
            } catch (e) {
                alert("Critical System Error.");
                btn.disabled = false;
                btn.innerText = "AUTHORIZE_DEPLOYMENT";
            }
        };
    </script>
</body>
</html>
